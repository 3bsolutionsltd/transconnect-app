// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums for PostgreSQL
enum UserRole {
  PASSENGER
  OPERATOR
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  MTN_MOBILE_MONEY
  AIRTEL_MONEY
  FLUTTERWAVE
  CASH
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String   @unique
  role      UserRole @default(PASSENGER)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings     Booking[]
  rides        Ride[]
  payments     Payment[]
  operator     Operator?
  notifications Notification[]
  notificationPreferences UserNotificationPreference?
  deviceTokens DeviceToken[]

  @@map("users")
}

model Operator {
  id          String   @id @default(cuid())
  companyName String
  license     String   @unique
  approved    Boolean  @default(false)
  userId      String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  buses  Bus[]
  routes Route[]

  @@map("operators")
}

model Bus {
  id           String   @id @default(cuid())
  plateNumber  String   @unique
  model        String
  capacity     Int
  amenities    String? // JSON string: AC, WiFi, etc.
  operatorId   String
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  operator Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  routes   Route[]

  @@map("buses")
}

model Route {
  id          String   @id @default(cuid())
  origin      String
  destination String
  distance    Float // in kilometers
  duration    Int   // in minutes
  price       Float
  departureTime String // Time format: "HH:MM"
  operatorId  String
  busId       String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  operator Operator  @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  bus      Bus       @relation(fields: [busId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@map("routes")
}

model Booking {
  id           String        @id @default(cuid())
  userId       String
  routeId      String
  seatNumber   String
  travelDate   DateTime
  status       BookingStatus @default(PENDING)
  qrCode       String
  totalAmount  Float
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  route        Route          @relation(fields: [routeId], references: [id], onDelete: Cascade)
  payment      Payment?
  verification Verification?

  @@map("bookings")
}

model Payment {
  id            String        @id @default(cuid())
  bookingId     String        @unique
  userId        String
  amount        Float
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique
  reference     String?       @unique
  metadata      Json?         // Store additional payment data
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  booking    Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  webhookLogs WebhookLog[]

  @@map("payments")
}

model WebhookLog {
  id            String   @id @default(cuid())
  gateway       String   // mtn, airtel, flutterwave
  transactionId String
  paymentId     String?
  status        String
  payload       Json     // The webhook payload
  processedAt   DateTime @default(now())

  // Relations
  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@map("webhook_logs")
}

model Ride {
  id           String   @id @default(cuid())
  userId       String
  origin       String
  destination  String
  departureTime DateTime
  availableSeats Int
  pricePerSeat Float
  description  String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("rides")
}

model Verification {
  id        String   @id @default(cuid())
  bookingId String   @unique
  scannedAt DateTime @default(now())
  scannedBy String   // Operator/driver ID
  location  String?  // GPS coordinates

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("verifications")
}

// Notification Models
model NotificationTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  type        NotificationType
  channel     NotificationChannel[]
  subject     String?  // For email notifications
  title       String   // Push notification title / SMS subject
  body        String   // Notification content with placeholders
  variables   Json?    // Available template variables
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  notifications Notification[]

  @@map("notification_templates")
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  templateId  String
  type        NotificationType
  channel     NotificationChannel
  recipient   String   // Phone number, email, or FCM token
  subject     String?
  title       String
  body        String
  data        Json?    // Additional data for the notification
  status      NotificationStatus @default(PENDING)
  sentAt      DateTime?
  readAt      DateTime?
  errorMessage String?
  retryCount  Int      @default(0)
  maxRetries  Int      @default(3)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  template NotificationTemplate @relation(fields: [templateId], references: [id])

  @@map("notifications")
}

model UserNotificationPreference {
  id       String   @id @default(cuid())
  userId   String   @unique
  email    Boolean  @default(true)
  sms      Boolean  @default(true)
  push     Boolean  @default(true)
  marketing Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_preferences")
}

model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  DevicePlatform
  isActive  Boolean  @default(true)
  lastUsed  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("device_tokens")
}

// Enums for notifications
enum NotificationType {
  BOOKING_CONFIRMATION
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  TRIP_REMINDER
  BUS_DELAYED
  BUS_CANCELLED
  RIDE_MATCHED
  ACCOUNT_VERIFICATION
  PROMOTIONAL
  SYSTEM_MAINTENANCE
  GENERAL
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  CANCELLED
}

enum DevicePlatform {
  ANDROID
  IOS
  WEB
}