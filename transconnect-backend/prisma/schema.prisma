// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums for PostgreSQL
enum UserRole {
  PASSENGER
  OPERATOR
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  MTN_MOBILE_MONEY
  AIRTEL_MONEY
  FLUTTERWAVE
  CASH
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String   @unique
  role      UserRole @default(PASSENGER)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings     Booking[]
  rides        Ride[]
  payments     Payment[]
  operator     Operator?

  @@map("users")
}

model Operator {
  id          String   @id @default(cuid())
  companyName String
  license     String   @unique
  approved    Boolean  @default(false)
  userId      String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  buses  Bus[]
  routes Route[]

  @@map("operators")
}

model Bus {
  id           String   @id @default(cuid())
  plateNumber  String   @unique
  model        String
  capacity     Int
  amenities    String? // JSON string: AC, WiFi, etc.
  operatorId   String
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  operator Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  routes   Route[]

  @@map("buses")
}

model Route {
  id          String   @id @default(cuid())
  origin      String
  destination String
  distance    Float // in kilometers
  duration    Int   // in minutes
  price       Float
  departureTime String // Time format: "HH:MM"
  operatorId  String
  busId       String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  operator Operator  @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  bus      Bus       @relation(fields: [busId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@map("routes")
}

model Booking {
  id           String        @id @default(cuid())
  userId       String
  routeId      String
  seatNumber   String
  travelDate   DateTime
  status       BookingStatus @default(PENDING)
  qrCode       String
  totalAmount  Float
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  route        Route          @relation(fields: [routeId], references: [id], onDelete: Cascade)
  payment      Payment?
  verification Verification?

  @@map("bookings")
}

model Payment {
  id            String        @id @default(cuid())
  bookingId     String        @unique
  userId        String
  amount        Float
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique
  reference     String?       @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Ride {
  id           String   @id @default(cuid())
  userId       String
  origin       String
  destination  String
  departureTime DateTime
  availableSeats Int
  pricePerSeat Float
  description  String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("rides")
}

model Verification {
  id        String   @id @default(cuid())
  bookingId String   @unique
  scannedAt DateTime @default(now())
  scannedBy String   // Operator/driver ID
  location  String?  // GPS coordinates

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("verifications")
}