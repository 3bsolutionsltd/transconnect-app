// Test QR scanning with real booking data to show what operators will see
const API_BASE_URL = 'https://transconnect-app-44ie.onrender.com/api';

async function testQRScanning() {
  console.log('üì± Testing QR Code Scanning - What Operators Will See\n');

  try {
    // Create a realistic QR code data that would be generated by our system
    const realBookingQRData = {
      bookingId: 'bk_1730896420847_kampala_jinja',
      passengerName: 'John Doe',
      route: 'Kampala ‚Üí Jinja',
      seatNumber: 'A12',
      travelDate: '2025-11-07T08:00:00.000Z',
      busPlate: 'UAH-001A',
      operator: 'Swift Safaris',
      timestamp: '2025-11-06T12:30:00.000Z',
      signature: 'sha256_demo_signature_abc123def456'
    };

    console.log('üé´ QR Code Data (what\'s encoded in the QR):');
    console.log('‚îÄ'.repeat(60));
    console.log(`üìã Booking ID: ${realBookingQRData.bookingId}`);
    console.log(`üë§ Passenger: ${realBookingQRData.passengerName}`);
    console.log(`üöå Route: ${realBookingQRData.route}`);
    console.log(`üí∫ Seat: ${realBookingQRData.seatNumber}`);
    console.log(`üìÖ Travel Date: ${new Date(realBookingQRData.travelDate).toLocaleString()}`);
    console.log(`üöê Bus Plate: ${realBookingQRData.busPlate}`);
    console.log(`üè¢ Operator: ${realBookingQRData.operator}`);
    console.log(`üîê Signature: ${realBookingQRData.signature}`);
    console.log('‚îÄ'.repeat(60));
    console.log('');

    // 1. Test scanning this QR code
    console.log('üîç Scanning QR Code...');
    console.log('(This is what happens when operator scans the QR code)');
    console.log('');

    const scanResponse = await fetch(`${API_BASE_URL}/qr/validate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        qrData: JSON.stringify(realBookingQRData),
        scannedBy: 'Operator John Smith',
        location: 'Kampala Bus Terminal'
      })
    });

    const scanResult = await scanResponse.json();
    
    console.log('üìä SCAN RESULT:');
    console.log('‚ïê'.repeat(60));
    
    if (scanResult.valid) {
      console.log('‚úÖ TICKET STATUS: VALID');
      console.log('');
      console.log('üë§ PASSENGER DETAILS:');
      console.log(`   Name: ${scanResult.bookingDetails?.passengerName || 'Not found'}`);
      console.log(`   Phone: ${scanResult.bookingDetails?.passengerPhone || 'Not found'}`);
      console.log('');
      console.log('üé´ JOURNEY DETAILS:');
      console.log(`   Route: ${scanResult.bookingDetails?.route || realBookingQRData.route}`);
      console.log(`   Seat: ${scanResult.bookingDetails?.seatNumber || realBookingQRData.seatNumber}`);
      console.log(`   Date: ${scanResult.bookingDetails?.travelDate ? new Date(scanResult.bookingDetails.travelDate).toLocaleDateString() : new Date(realBookingQRData.travelDate).toLocaleDateString()}`);
      console.log(`   Bus: ${scanResult.bookingDetails?.busPlate || realBookingQRData.busPlate}`);
      console.log(`   Operator: ${scanResult.bookingDetails?.operator || realBookingQRData.operator}`);
      console.log('');
      console.log('üïí SCAN HISTORY:');
      console.log(`   Scanned by: ${scanResult.scanDetails?.scannedBy || 'First scan'}`);
      console.log(`   Scan time: ${scanResult.scanDetails?.scannedAt ? new Date(scanResult.scanDetails.scannedAt).toLocaleString() : 'Just now'}`);
      console.log(`   Location: ${scanResult.scanDetails?.location || 'Kampala Bus Terminal'}`);
      
      if (scanResult.alreadyScanned) {
        console.log('‚ö†Ô∏è  WARNING: This ticket was already scanned!');
      } else {
        console.log('üÜï FIRST SCAN: Passenger can board');
      }
    } else {
      console.log('‚ùå TICKET STATUS: INVALID');
      console.log(`   Error: ${scanResult.error}`);
      console.log('   Action: Do not allow boarding');
    }
    
    console.log('‚ïê'.repeat(60));
    console.log('');

    // 2. Test scanning the same QR again (duplicate scan)
    console.log('üîÑ Testing duplicate scan (scanning same QR again)...');
    const duplicateScanResponse = await fetch(`${API_BASE_URL}/qr/validate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        qrData: JSON.stringify(realBookingQRData),
        scannedBy: 'Operator Jane Doe',
        location: 'Kampala Bus Terminal - Gate 2'
      })
    });

    const duplicateResult = await duplicateScanResponse.json();
    console.log('');
    console.log('üìä DUPLICATE SCAN RESULT:');
    console.log('‚ïê'.repeat(60));
    
    if (duplicateResult.valid && duplicateResult.alreadyScanned) {
      console.log('‚ö†Ô∏è  TICKET STATUS: ALREADY SCANNED');
      console.log('');
      console.log('üîç PREVIOUS SCAN DETAILS:');
      console.log(`   Originally scanned by: ${duplicateResult.scanDetails?.scannedBy}`);
      console.log(`   Original scan time: ${new Date(duplicateResult.scanDetails?.scannedAt).toLocaleString()}`);
      console.log(`   Original location: ${duplicateResult.scanDetails?.location}`);
      console.log('');
      console.log('üë§ PASSENGER DETAILS (still visible):');
      console.log(`   Name: ${duplicateResult.bookingDetails?.passengerName || realBookingQRData.passengerName}`);
      console.log(`   Route: ${duplicateResult.bookingDetails?.route || realBookingQRData.route}`);
      console.log(`   Seat: ${duplicateResult.bookingDetails?.seatNumber || realBookingQRData.seatNumber}`);
      console.log('');
      console.log('‚ö†Ô∏è  ACTION: Ticket already used - investigate duplicate');
    }
    
    console.log('‚ïê'.repeat(60));
    console.log('');

    // 3. Test invalid QR code
    console.log('üö´ Testing invalid QR code...');
    const invalidQRData = {
      bookingId: 'fake-booking-123',
      passengerName: 'Fake User',
      route: 'Nowhere ‚Üí Somewhere',
      seatNumber: 'Z99',
      travelDate: '2025-01-01T00:00:00.000Z',
      busPlate: 'FAKE-001',
      operator: 'Fake Transport',
      timestamp: '2025-01-01T00:00:00.000Z',
      signature: 'invalid_signature'
    };

    const invalidScanResponse = await fetch(`${API_BASE_URL}/qr/validate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        qrData: JSON.stringify(invalidQRData),
        scannedBy: 'Operator Security',
        location: 'Kampala Bus Terminal'
      })
    });

    const invalidResult = await invalidScanResponse.json();
    console.log('');
    console.log('üìä INVALID QR SCAN RESULT:');
    console.log('‚ïê'.repeat(60));
    console.log('‚ùå TICKET STATUS: INVALID');
    console.log(`   Error: ${invalidResult.error}`);
    console.log('   Action: Reject passenger - possible fraud');
    console.log('‚ïê'.repeat(60));

    console.log('');
    console.log('üéØ SUMMARY FOR OPERATORS:');
    console.log('‚ñ∂Ô∏è  Green ‚úÖ = Valid ticket, allow boarding');
    console.log('‚ñ∂Ô∏è  Yellow ‚ö†Ô∏è  = Already scanned, investigate');  
    console.log('‚ñ∂Ô∏è  Red ‚ùå = Invalid ticket, deny boarding');
    console.log('');
    console.log('üì± QR scanning provides:');
    console.log('   ‚Ä¢ Passenger verification');
    console.log('   ‚Ä¢ Journey details confirmation');
    console.log('   ‚Ä¢ Duplicate scan detection');
    console.log('   ‚Ä¢ Audit trail for security');

  } catch (error) {
    console.error('‚ùå QR Scanning test failed:', error.message);
  }
}

testQRScanning();